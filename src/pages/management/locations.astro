---
import Layout from "../../layouts/Layout.astro";
import { supabase } from "../../db/supabase";

const { cookies, redirect } = Astro;

const accessToken = cookies.get("sb-access-token");
const refreshToken = cookies.get("sb-refresh-token");

if (!accessToken || !refreshToken) {
    cookies.set("referrer-url", Astro.url.pathname, {
        path: "/",
    });
    return redirect("/login");
}

const { data, error } = await supabase.auth.setSession({
    refresh_token: refreshToken.value,
    access_token: accessToken.value,
});

if (error) {
    cookies.delete("sb-access-token", {
        path: "/",
    });
    cookies.delete("sb-refresh-token", {
        path: "/",
    });

    return redirect("/login");
}

const email = data.user?.email;
if (email !== "admin@coffee.place") {
    return redirect("/");
}

const locations = [
    {
        uuid: "u3z",
        neighborhood: "Kozari bok",
        street_address: "Unska 3",
        city: "Zagreb",
    },
    {
        uuid: "upf42pv",
        neighborhood: "Pituraša",
        street_address: "Ulica Par Frulica 42",
        city: "Prduša Vela",
    },
    {
        uuid: "ugz9g",
        neighborhood: "Bronx",
        street_address: "Ulica grada Zagreba 9",
        city: "Varaždin",
    },
];
---

<Layout title="CoffeePlace">
    <main>
        <article
            class="vertical-margin medium-elevate medium-width center surface"
        >
            <div
                class="field large prefix round fill small-elevate bottom-margin medium-margin"
            >
                <i class="front">search</i>
                <input
                    v-model="searchQuery"
                    class="primary-hover"
                    type="text"
                    placeholder="Pretražite lokacije..."
                />
            </div>
            <div class="small-divider"></div>
            <div>
                {
                    locations.map((location) => (
                        <div class="bottom-margin small-margin">
                            <a href={"/locations/" + location.uuid}>
                                <div>
                                    <h6>{location.neighborhood}</h6>
                                    <span>
                                        {location.street_address +
                                            ", " +
                                            location.city}
                                    </span>
                                </div>
                            </a>
                        </div>
                    ))
                }
            </div>
        </article>
    </main>
</Layout>
